# Семестровая работа по Базам Данных

## Предметная область базы данных

Данная база данных предназначена для веб-приложения с рецептами и составлять персональные подборки с ними.
А также существует лист покупок, если пользователь захочет приготовить какой-то рецепт,
но у него не будет нужных ингредиентов, ему не придется держать это в голове, "в пару кликов" добавить ингредиент в лист
(это уже бизнес слой сервиса).

Каждому рецепту пользователь может задать теги, категории и ингредиенты
(которые заранее внесены в систему, изменять могут только админы).

Ведется учет просмотра рецептов, а также пользователи в праве оставить отзывы на любой рецепт
(только один отзыв от одного пользователя на рецепт).

### Сущности

Все сущности (кроме просмотров) обладают временными метками для управления их жизненного цикла

#### Основные сущности

* `user` — пользователь системы. Содержит учетные данные, информацию о профиле.
* `recipe` — рецепт. Основная публикуемая единица, содержит название, описание, время приготовления,
  количество порций, изображение, а также агрегированные показатели просмотров и рейтинга.
* `review` — отзыв на рецепт. Включает оценку (1-5) и текстовый комментарий, оставленный пользователем.
* `shop_list` — список покупок. Принадлежит пользователю и содержит набор ингредиентов для закупки.
* `collection` — коллекция рецептов. Позволяет пользователю группировать рецепты по тематике.

#### Сущность для безопасности

* `session` — сессия пользователя. Хранит идентификатор сессии, ссылку на пользователя и время истечения
  для управления аутентификацией.

#### Сущности для фильтрации и классификации

* `ingredient` — ингредиент. Справочник пищевых продуктов с возможностью иерархической организации.
* `category` — категория рецептов. Иерархическая структура для тематической группировки рецептов.
* `tag` — тег. Гибкая метка для дополнительной пометки рецептов.

#### Структурные сущности

* `recipe_view` — факт просмотра рецепта. Фиксирует, какой пользователь (или аноним) когда просматривал рецепт.
  Используется для статистики и рекомендаций.
* `recipe_step` — шаг приготовления. Часть инструкции рецепта с порядковым номером,
  описанием и опциональным изображением.

---

## Обоснование выбора типов данных

* `created_at`, `deleted_at` и `updated_at` - одинаково типа для удобства сравнения, также время нужно временная зона
  нужна для того, чтобы пользователь корректно видел время, кому-то явно не понравиться увидеть,
  что рецепт, который он загрузил сегодня, отображается у него как вчерашний,
  время в принципе нужно для удобства сортировки. Эти поля у всех одинакового типа, для целостности.

* `BIGSERIAL` (и соответственно `BIGINT`) у всех основных и структурных сущностей как айди,
  так как пользователей может быть много, а следовательно и данных, которые они могут добавить тоже

* `SMALLSERIAL` (и соответственно `SMALLINT`) как айди у всех сущностей для фильтрации,
  потому что их ограниченное количество и рамки `SMALLINT` для них более чем достаточны

* в самом файлике создание табличек есть комментарии, к некоторым чекам и данным

---

## Бизнес-логика функций

#### Функция: `add_recipe_with_details`

**Бизнес-логика:**

* Пользователь вводит все данные рецепта сразу, сервер обрабатывает их и передает в нужном формате запрос на добавление
  данных в БД
* Все нужные данные по рецепту добавляются сразу
* По завершению возвращает: статус код и сообщение, в формате для веб-сервиса


#### Функция: `update_recipe_with_details`

**Бизнес-логика:**

* Работает по антологии с `add_recipe_with_details`, но с более глубоким подходом к дополнительным данным
* Если доп данные переданы как `null`, то изменений нет, иначе выполняется нужная функция


### Функции: `update_recipe_ingredient`, `update_recipe_step`, `update_recipe_category`, `update_recipe_tag`

**Бизнес-логика:**

* Если им передается пустые массивы, то старые зависимости удаляются, иначе производиться добавление нужных данных

---

## Бизнес-логика триггеров

### 1. Защита поля `created_at` от изменений

#### Триггер: `protect_created_at()`

**Назначение:** Запрещает изменение поля `created_at` при обновлении записей.

**Бизнес-логика:**

- Поле `created_at` хранит дату создания записи и должно оставаться неизменным в течение всего жизненного цикла объекта
- При попытке изменения `created_at` триггер автоматически восстанавливает исходное значение
- Используется для всех таблиц для обеспечения целостности временных меток

### 2. Автоматическое обновление поля `updated_at`

#### Триггер: `set_updated_at()`

**Назначение:** Автоматически обновляет поле `updated_at` текущей временной меткой при изменении записи.

**Бизнес-логика:**

- Обеспечивает отслеживание времени последнего изменения записи
- Применяется к таблицам: `user`, `recipe`, `review`

### 3. Расчет среднего рейтинга рецепта

#### Триггер: `update_recipe_rating()`

**Назначение:** Пересчитывает средний рейтинг рецепта при изменении отзывов.

**Бизнес-логика:**

- Автоматически обновляет поле `rating` в таблице `recipe` при: добавлении, изменении и удалении отзывов.
- Рассчитывает среднее арифметическое всех активных отзывов (с `deleted_at IS NULL` остальные игнорируются)

### 4. Увеличение счетчика просмотров рецепта

#### Триггер: `update_recipe_views()`

**Назначение:** Увеличивает счетчик просмотров при добавлении записи о просмотре.

**Бизнес-логика:**
Каждый новый просмотр (запись в `recipe_view`) увеличивает `views` в таблице `recipe` на 1

### 5. Управление дубликатами в связующих таблицах

#### Общий принцип бизнес-логики:

**Назначение:** Предотвращение дублирования связей с поддержкой мягкого удаления.

**Сценарии обработки:**

1. **Запись не существует** - Создать новую
2. **Запись существует и активна (deleted_at IS NULL)** - Игнорировать (предотвратить дубликат)
3. **Запись существует и удалена (deleted_at NOT NULL)** - Создать новую (восстановление связи)

#### 5.1 Простая проверка (для `recipe_category`, `recipe_tag`, `collection_recipe`)

**Триггер:** `upsert_recipe_category()`, `upsert_recipe_tag()`, `upsert_collection_recipe()`
**Логика:** Проверяет только наличие связи без учета параметров

#### 5.2 Проверка с учетом параметров (для `recipe_ingredient`, `shop_list_item`, `review`)

**Триггер:** `upsert_recipe_ingredient()`, `upsert_shop_list_item()`, `upsert_review()`
**Логика:** Проверяет не только наличие связи, но и параметры (количество, единицы измерения, заметка и т.д.)
**Дополнительная логика:**

- Если связь существует, но параметры отличаются:
- Помечает старую запись как удаленную
- Создает новую запись с обновленными параметрами

----

## Примеры использования представлений

1. **user_statistics** — Статистика по пользователям, может понадобиться админу,
   либо сам пользователь захочет узнать свои данные.

2. **recipe_detailed_report** — Детальная аналитика рецептов

3. **recipe_enhanced** — Более детальная информация об рецепте

4. **quick_recipes_with_reviews** — Быстрые рецепты с отзывами (пример часто используемого поискового условия)

5. **public_user_profiles** — Публичные профили пользователей 


